name: Build, Push to Private Registry and Deploy with Helm

on:
  push:
    branches: [ main ]

env:
  # IP вашего приватного реджистри
  REGISTRY: "192.168.31.158:30500"
  IMAGE_NAME: "django-app"
  K8S_NAMESPACE: "django-app"
  HELM_RELEASE: "django-app-production"

jobs:
  build-and-push:
    # ВАЖНО: используем self-hosted раннер, так как GitHub не видит ваш локальный IP
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      # Настройка Docker Buildx (нужно для кэширования и работы драйверов)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # Эта опция позволяет сборщику видеть сеть хоста
          driver-opts: network=host
          # А вот это самое важное - разрешаем HTTP для твоего IP
          buildkitd-config-inline: |
            [registry."192.168.31.158:30500"]
              http = true
              insecure = true
      # Логинимся в локальный реджистри (пароль берем явно или через секреты, 
      # для простоты в лабе можно хардкодом, но лучше secrets.REGISTRY_PASSWORD)
      - name: Log in to private registry
        run: docker login ${{ env.REGISTRY }} -u admin -p admin123

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy-with-helm:
    needs: build-and-push
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      # Установка Helm (если вдруг нет на раннере)
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        continue-on-error: true # Если уже стоит, не падать

      - name: Deploy with Helm
        run: |
          # 1. Создаем namespace если нет
          kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          
          # 2. Обновляем зависимости чарта (на всякий случай)
          # Используем OCI, чтобы не было ошибки 403
          helm dependency update ./django-app-chart --skip-refresh

          # 3. Деплоим/Обновляем
          helm upgrade --install ${{ env.HELM_RELEASE }} ./django-app-chart \
            --namespace ${{ env.K8S_NAMESPACE }} \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ github.sha }} \
            --wait \
            --timeout 300s
